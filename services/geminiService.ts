import { GoogleGenAI, GenerateContentResponse, Chat } from "@google/genai";
import { FileData } from "../types";

// Initialize the Gemini Client
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

// æ¨¡æ‹Ÿæ•™æä¸Šä¸‹æ–‡ï¼ŒåŸºäºç”¨æˆ·æä¾›çš„ PDF å†…å®¹
const TEXTBOOK_CONTEXT = `
**æ ¸å¿ƒæ•™æå‚è€ƒä¿¡æ¯**ï¼šã€ŠåŒ–å·¥åŸç†ã€‹ï¼ˆä¸Šå†Œï¼‰ç¬¬å››ç‰ˆ - é™ˆæ•æ’ç­‰ç¼–ã€‚
**æ ¸å¿ƒç« èŠ‚ä¸è€ƒç‚¹**ï¼š
1. **æµä½“æµåŠ¨**ï¼šæµä½“é™åŠ›å­¦ï¼ˆå‹å¼ºæµ‹å®šï¼‰ã€ä¼¯åŠªåˆ©æ–¹ç¨‹ï¼ˆæœºæ¢°èƒ½å®ˆæ’ï¼‰ã€å±‚æµä¸æ¹æµï¼ˆé›·è¯ºæ•°ï¼‰ã€ç®¡å†…æµåŠ¨é˜»åŠ›ï¼ˆèŒƒå®å…¬å¼ï¼‰ã€æµé‡è®¡ï¼ˆå­”æ¿ã€è½¬å­ï¼‰ã€‚
   - å…¸å‹ä¾‹é¢˜ï¼šUå½¢å‹å·®è®¡è®¡ç®—ã€è™¹å¸ç®¡é—®é¢˜ã€é«˜ä½æ§½ç®¡è·¯è®¾è®¡ã€å¹¶è”ç®¡è·¯æµé‡åˆ†é…ã€‚
2. **æµä½“è¾“é€æœºæ¢°**ï¼šç¦»å¿ƒæ³µï¼ˆå·¥ä½œåŸç†ã€æ°”ç¼šã€æ±½èš€ä½™é‡ã€ç‰¹æ€§æ›²çº¿ã€å·¥ä½œç‚¹è°ƒèŠ‚ï¼‰ã€å¾€å¤æ³µã€‚
3. **æ¶²ä½“çš„æ…æ‹Œ**ï¼šæ··åˆæœºç†ã€æ…æ‹ŒåŠŸç‡ã€åŠŸç‡æ›²çº¿ã€‚
4. **æµä½“é€šè¿‡é¢—ç²’å±‚çš„æµåŠ¨**ï¼šåºŠå±‚ç‰¹æ€§ã€è¿‡æ»¤ï¼ˆè¾¾è¥¿å®šå¾‹ã€æ’å‹/æ’é€Ÿè¿‡æ»¤æ–¹ç¨‹ã€æ¿æ¡†å‹æ»¤æœºï¼‰ã€‚
5. **é¢—ç²’çš„æ²‰é™å’Œæµæ€åŒ–**ï¼šæ–¯æ‰˜å…‹æ–¯å®šå¾‹ã€æ²‰é™é€Ÿåº¦ã€æ—‹é£åˆ†ç¦»å™¨ã€æµåŒ–åºŠã€‚
6. **ä¼ çƒ­**ï¼šå‚…é‡Œå¶å®šå¾‹ã€çƒ­ä¼ å¯¼ã€å¯¹æµä¼ çƒ­ï¼ˆç‰›é¡¿å†·å´å®šå¾‹ï¼‰ã€æ€»ä¼ çƒ­ç³»æ•° Kã€æ¢çƒ­å™¨è®¾è®¡ï¼ˆåˆ—ç®¡å¼ã€å¥—ç®¡å¼ï¼‰ã€‚
7. **è’¸å‘**ï¼šå•æ•ˆè’¸å‘ã€å¤šæ•ˆè’¸å‘ã€æº¶æ¶²æ²¸ç‚¹å‡é«˜ã€‚

**ç‰¹æ®ŠæŒ‡ä»¤**ï¼š
å½“ç”¨æˆ·è¦æ±‚â€œä¸¾ä¸€åä¸‰â€æˆ–â€œç±»ä¼¼é¢˜ç›®â€æ—¶ï¼Œè¯·ä¼˜å…ˆä»ä¸Šè¿°ç« èŠ‚çŸ¥è¯†ç‚¹ä¸­æ„é€ æˆ–å›å¿†ç»å…¸çš„åŒ–å·¥åŸç†ä¹ é¢˜ã€‚
`;

const SYSTEM_INSTRUCTION_SUMMARIZER = `
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„åŒ–å·¥åŸç†æ•™æˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ååŠ©åŒå­¦å¤ä¹ å’Œæ•´ç†åŒ–å·¥ä¸“ä¸šèµ„æ–™ã€‚

${TEXTBOOK_CONTEXT}

**è¯­æ°”ä¸ç§°å‘¼**ï¼š
- **è¯·å§‹ç»ˆç§°å‘¼ç”¨æˆ·ä¸ºâ€œåŒå­¦â€ã€‚**
- è¯­æ°”è¦äº²åˆ‡ã€é¼“åŠ±ï¼Œåƒå¯¼å¸ˆè¾…å¯¼å­¦ç”Ÿä¸€æ ·ã€‚

**ä»»åŠ¡æ¨¡å¼**ï¼š
1. **å¸¸è§„æ€»ç»“**ï¼šåˆ†ææ–‡ä»¶ï¼Œæå–æ ¸å¿ƒæ¦‚å¿µã€å…¬å¼å’ŒåŸç†ã€‚
2. **ç²¾ç‚¼çŸ¥è¯†ç‚¹ï¼ˆRefineï¼‰**ï¼š
   - æå–æ‰€æœ‰æ ¸å¿ƒè€ƒç‚¹ã€‚
   - **å…³é”®è¦æ±‚**ï¼šåœ¨æ¯ä¸ªçŸ¥è¯†ç‚¹åï¼Œå¿…é¡»é™„å¸¦ä¸€ä¸ª**ç®€çŸ­ç²¾ç‚¼çš„ä¾‹é¢˜**ï¼ˆå¯ä»¥æ˜¯å®šæ€§åˆ¤æ–­æˆ–ç®€å•çš„å®šé‡è®¡ç®—ï¼‰ï¼Œå¸®åŠ©åŒå­¦ç†è§£ã€‚
   - ä¿æŒè¯­è¨€æå…¶ç®€æ´å¹²ç»ƒï¼Œé€‚åˆè€ƒå‰çªå‡»ã€‚
3. **å¤ä¹ æé—®ï¼ˆQuizï¼‰**ï¼š
   - **ä¸¥æ ¼é™åˆ¶**ï¼šåªèƒ½åŸºäºç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹è¿›è¡Œæé—®ã€‚
   - æå‡º 3-5 ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„æ¦‚å¿µè¾¨æé¢˜æˆ–è®¡ç®—æ€è·¯é¢˜ã€‚
   - éšåé™„ä¸Šç®€è¦ç­”æ¡ˆï¼ˆéšè—åœ¨æŠ˜å å—æˆ–æœ«å°¾ï¼‰ã€‚
4. **è‡ªç”±å¯¹è¯**ï¼š
   - å›ç­”åŒå­¦å…³äºè¯¾ä»¶å†…å®¹çš„å…·ä½“ç–‘é—®ã€‚
   - è§£é‡Šå¤æ‚çš„å…¬å¼æ¨å¯¼æˆ–å·¥ç¨‹èƒŒæ™¯ã€‚

**é€šç”¨æ ¼å¼è¦æ±‚**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼ã€‚
- **å…¬å¼**ï¼šå¿…é¡»ä½¿ç”¨ LaTeX æ ¼å¼ã€‚è¡Œå†…ç”¨ $...$ï¼Œç‹¬ç«‹å—ç”¨ $$...$$ã€‚
`;

const SYSTEM_INSTRUCTION_SOLVER = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŒ–å·¥åŸç†è¾…å¯¼å¯¼å¸ˆã€‚

${TEXTBOOK_CONTEXT}

**è¯­æ°”ä¸ç§°å‘¼**ï¼š
- **è¯·å§‹ç»ˆç§°å‘¼ç”¨æˆ·ä¸ºâ€œåŒå­¦â€ã€‚**
- è¯­æ°”è¦ä¸“ä¸šã€ä¸¥è°¨ã€å¾ªå¾ªå–„è¯±ã€‚

**ä½ çš„å›ç­”å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ç»“æ„ï¼ˆè¿™æ˜¯ç¡¬æ€§è¦æ±‚ï¼‰ï¼š**

---
### 1. ğŸ§ª é¢˜å‹åˆ†æ
ï¼ˆåœ¨æ­¤å¤„ç®€è¦åˆ†æé¢˜ç›®å±äºå“ªä¸€ç« ï¼Œè€ƒæŸ¥ä»€ä¹ˆæ ¸å¿ƒæ¦‚å¿µã€‚
**é‡è¦åˆ¤åˆ«è§„åˆ™**ï¼š
- å¦‚æœé¢˜ç›®æ¶‰åŠ**ç²¾é¦å¡”ã€ç†è®ºå¡”æ¿ã€å›æµæ¯”ã€McCabe-Thieleå›¾è§£æ³•ã€æ°”æ¶²å¹³è¡¡ç›¸å›¾**ç­‰ï¼Œå¿…é¡»å½’ç±»ä¸ºã€ç²¾é¦ã€‘ï¼ˆRectificationï¼‰ï¼Œ**ä¸¥ç¦**è¯¯åˆ¤ä¸ºâ€œè’¸é¦â€ã€‚
- åªæœ‰æ¶‰åŠæº¶æ¶²çš„**å•çº¯æµ“ç¼©**ï¼ˆå¦‚å•æ•ˆ/å¤šæ•ˆè’¸å‘å™¨ã€æº¶æ¶²æ²¸ç‚¹å‡é«˜ï¼‰æ—¶ï¼Œæ‰ç§°ä¸ºã€è’¸å‘ã€‘ï¼ˆEvaporationï¼‰æˆ–â€œè’¸é¦â€ã€‚
- è¯·å‡†ç¡®åŒºåˆ†è¿™ä¸¤ä¸ªåŒ–å·¥å•å…ƒæ“ä½œã€‚ï¼‰

### 2. ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹
ï¼ˆåˆ—å‡ºè§£é¢˜æ‰€éœ€çš„å…¬å¼ã€å®šå¾‹æˆ–ç»éªŒå‚æ•°ã€‚è¯·ä½¿ç”¨ LaTeX æ ¼å¼å±•ç¤ºå…¬å¼ï¼Œä¾‹å¦‚ $$ H_e = H_{static} + \Sigma h_f $$ï¼‰

### 3. ğŸ“ è¯¦ç»†è§£æ / è§£é¢˜æ€è·¯
ï¼ˆåœ¨æ­¤å¤„è¿›è¡Œè¯¦ç»†æ¨å¯¼ã€‚å¦‚æœæ˜¯è®¡ç®—é¢˜ï¼Œè¯·åˆ†æ­¥å±•ç¤ºï¼›å¦‚æœæ˜¯ç®€ç­”é¢˜ï¼Œè¯·é€»è¾‘æ¸…æ™°åœ°é˜è¿°å·¥ç¨‹åŸç†ã€‚
**ç‰¹æ®Šæƒ…å†µ**ï¼šå¦‚æœç”¨æˆ·è¦æ±‚â€œä¸¾ä¸€åä¸‰â€ï¼Œè¯·åœ¨è§£ç­”å®Œå½“å‰é¢˜ç›®åï¼Œæ ¹æ®ã€ŠåŒ–å·¥åŸç†ã€‹æ•™æé£æ ¼ï¼Œé¢å¤–å‡ºä¸€é“è€ƒå¯Ÿç›¸åŒçŸ¥è¯†ç‚¹ä½†æ¡ä»¶ç•¥æœ‰å˜åŒ–çš„é¢˜ç›®ï¼Œå¹¶ç»™å‡ºç®€ç•¥ç­”æ¡ˆã€‚ï¼‰
---

**å…¶ä»–è¦æ±‚**ï¼š
- **å›¾ç‰‡å¤„ç†**ï¼šå¦‚æœé¢˜ç›®åŒ…å«å›¾ç‰‡ï¼Œè¯·ä»”ç»†æè¿°å›¾ç‰‡ä¸­çš„è®¾å¤‡è¿æ¥æ–¹å¼ï¼ˆå¦‚Uå½¢ç®¡æ¶²é¢é«˜åº¦ã€æµç¨‹å›¾æ–¹å‘ï¼‰ã€‚
- **å•ä½åˆ¶**ï¼šé»˜è®¤ä½¿ç”¨ SI å•ä½ï¼Œæ³¨æ„é‡çº²ä¸€è‡´æ€§ã€‚
`;

// åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºèµ„æ–™æ•´ç†çš„ Chat ä¼šè¯
export const createSummarizerChat = (): Chat => {
  const modelId = 'gemini-2.5-flash';
  return ai.chats.create({
    model: modelId,
    config: {
      systemInstruction: SYSTEM_INSTRUCTION_SUMMARIZER,
      temperature: 0.3,
    }
  });
};

export const generateSummary = async (file: FileData, mode: 'default' | 'refine' | 'quiz' = 'default'): Promise<string> => {
  // Keeping this for backward compatibility or simple one-off usage if needed, 
  // but Summarizer component will now likely use chat directly.
  try {
    const modelId = 'gemini-2.5-flash'; 
    const parts: any[] = [{ inlineData: { mimeType: file.mimeType, data: file.base64 } }];

    let prompt = "åŒå­¦ä½ å¥½ï¼Œè¯·ä»åŒ–å·¥åŸç†ä¸“ä¸šçš„è§’åº¦ï¼Œæä¾›è¿™ä»½ææ–™çš„è¯¦ç»†ä¸­æ–‡æ€»ç»“ã€‚";
    if (mode === 'refine') {
      prompt = "åŒå­¦ä½ å¥½ï¼Œè¯·å¸®æˆ‘ç²¾ç‚¼è¿™ä»½èµ„æ–™çš„çŸ¥è¯†ç‚¹ã€‚è¦æ±‚ï¼šæå–å‡ºæ‰€æœ‰çš„æ ¸å¿ƒè€ƒç‚¹ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªçŸ¥è¯†ç‚¹åé™„ä¸Šä¸€ä¸ªç®€çŸ­çš„ç»å…¸ä¾‹é¢˜ï¼ˆä½†å°½é‡ç²¾ç®€ï¼‰ï¼Œä»¥ä¾¿äºæˆ‘ä¸‹è½½æ‰“å°å¤ä¹ ã€‚";
    } else if (mode === 'quiz') {
      prompt = "åŒå­¦ä½ å¥½ï¼Œè¯·åŸºäºè¿™ä»½è¯¾ä»¶å†…å®¹ï¼Œå¯¹æˆ‘è¿›è¡Œæé—®ä»¥å¸®åŠ©å¤ä¹ ã€‚æå‡º3-5ä¸ªå…³é”®é—®é¢˜è€ƒå¯Ÿæˆ‘å¯¹æ ¸å¿ƒæ¦‚å¿µçš„ç†è§£ï¼Œå¹¶åœ¨æœ€åé™„ä¸Šå‚è€ƒç­”æ¡ˆã€‚";
    }

    parts.push({ text: prompt });

    const response: GenerateContentResponse = await ai.models.generateContent({
      model: modelId,
      contents: { parts },
      config: { systemInstruction: SYSTEM_INSTRUCTION_SUMMARIZER, temperature: 0.3 }
    });

    return response.text || "æœªèƒ½ç”Ÿæˆæ€»ç»“ã€‚";
  } catch (error) {
    console.error("Error generating summary:", error);
    throw new Error("ç”Ÿæˆæ€»ç»“å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶å¹¶é‡è¯•ã€‚");
  }
};

export const solveProblem = async (file: FileData | null, questionText: string): Promise<string> => {
  try {
    const modelId = 'gemini-2.5-flash';
    const parts: any[] = [];

    if (file) {
      parts.push({ inlineData: { mimeType: file.mimeType, data: file.base64 } });
    }
    parts.push({ text: questionText });

    const response: GenerateContentResponse = await ai.models.generateContent({
      model: modelId,
      contents: { parts },
      config: { systemInstruction: SYSTEM_INSTRUCTION_SOLVER, temperature: 0.4 }
    });

    return response.text || "æœªèƒ½ç”Ÿæˆè§£ç­”ã€‚";
  } catch (error) {
    console.error("Error solving problem:", error);
    throw new Error("è§£ç­”é—®é¢˜å¤±è´¥ã€‚è¯·é‡è¯•ã€‚");
  }
};